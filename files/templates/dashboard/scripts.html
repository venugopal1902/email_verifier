<script>
    // --- DARK MODE ---
    function toggleTheme() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
    }

    // --- CONFIG ---
    const API_CREDITS = '/api/v1/credits/';
    const API_BASE = '/api/v1/upload/';
    const HISTORY_URL = '/api/v1/history/';
    const LIST_UPLOAD_URL = '/api/v1/lists/upload/';
    
    // STATE
    const token = localStorage.getItem('access_token');
    let userData = {};
    try { userData = JSON.parse(localStorage.getItem('user_data') || '{}'); } catch(e) {}

    // DOM
    const authContent = document.getElementById('authenticated-content');
    const guestContent = document.getElementById('unauthenticated-message');
    const logoutBtn = document.getElementById('logout-btn');
    const loginLink = document.getElementById('login-link');
    const userEmail = document.getElementById('user-email');
    const refreshIndicator = document.getElementById('auto-refresh-indicator');

    // INIT
    if (token) {
        authContent.classList.remove('hidden');
        guestContent.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        loginLink.classList.add('hidden');
        userEmail.textContent = userData.email || 'User';
        document.getElementById('credit-container').classList.remove('hidden'); 
        
        fetchCredits();
        setInterval(fetchCredits, 10000); 
        fetchData();
        setInterval(fetchData, 1000);
    } else {
        authContent.classList.add('hidden');
        guestContent.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        loginLink.classList.remove('hidden');
    }

    function logout() {
        localStorage.clear();
        window.location.href = '/login/';
    }

    // --- FETCHERS ---
    async function fetchData() {
        if (!token) return;
        try {
            const res = await fetch(HISTORY_URL, { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const data = await res.json();
                updateTable(data.files);
            }
        } catch (e) { }
    }

    async function fetchCredits() {
        if (!token) return;
        try {
            const res = await fetch(API_CREDITS, { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const data = await res.json();
                document.getElementById('credit-balance').textContent = Number(data.credits).toLocaleString();
            }
        } catch(e) {}
    }

    // --- CORE UPDATE LOGIC ---
    function updateTable(files) {
        const container = document.getElementById('status-area');
        
        if (!files || files.length === 0) {
            container.innerHTML = '<div class="p-12 text-center text-gray-400 text-sm">No verification history found.</div>';
            return;
        }

        let hasActiveTasks = false;

        // [FIX 1] Reverse the list logic so Newest items stay at TOP when using 'afterbegin'
        // 'files' comes as [Newest, Older, Oldest]. 
        // We reverse to [Oldest, Older, Newest] so when we prepend, Newest ends up on top.
        const reversedFiles = files.slice().reverse();

        reversedFiles.forEach(f => {
            if (f.status === 'PROCESSING' || f.status === 'UPLOADED') hasActiveTasks = true;

            let row = document.getElementById(`row-${f.file_id}`);
            
            // Stats
            let processed = (f.filtered_bounce_count||0) + (f.filtered_unsub_count||0) + (f.unique_record_count||0) + (f.invalid_record_count||0);
            let total = f.original_record_count || 1;
            let percent = 0;
            if (total > 0) percent = Math.min(Math.round((processed / total) * 100), 100);
            if (f.status === 'COMPLETED') percent = 100;

            // Date Formatting
            let startDateStr = "Pending...";
            if (f.started_at) {
                const d = new Date(f.started_at);
                if (!isNaN(d) && d.getFullYear() > 1970) startDateStr = d.toLocaleString();
            }

            // Create Row if missing
            if (!row) {
                const rowHtml = `
                <div id="row-${f.file_id}" class="grid grid-cols-12 gap-4 p-4 text-sm items-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition border-b border-gray-50 dark:border-gray-700 fade-in">
                    
                    <div class="col-span-3 overflow-hidden">
                        <div class="font-semibold text-gray-900 dark:text-white truncate" title="${f.file_name}">${f.file_name}</div>
                        
                        <div id="meta-${f.file_id}">
                            <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ${startDateStr}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-2 text-center" id="status-${f.file_id}"></div>
                    
                    <div class="col-span-1 flex justify-center items-center">
                         <div class="relative w-8 h-8">
                            <svg class="w-8 h-8 transform -rotate-90" viewBox="0 0 100 100">
                                <circle class="text-gray-200 dark:text-gray-600 stroke-current" stroke-width="10" cx="50" cy="50" r="40" fill="transparent"></circle>
                                <circle id="ring-${f.file_id}" class="text-indigo-600 stroke-current transition-all duration-500 ease-out" stroke-width="10" stroke-linecap="round" cx="50" cy="50" r="40" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
                            </svg>
                            <span id="perc-${f.file_id}" class="absolute inset-0 flex items-center justify-center text-[8px] font-bold text-gray-700 dark:text-gray-300">${percent}%</span>
                         </div>
                    </div>

                    <div class="col-span-1 text-center font-mono font-medium text-gray-600 dark:text-gray-400" id="bounce-${f.file_id}">-</div>
                    <div class="col-span-1 text-center font-mono font-medium text-gray-600 dark:text-gray-400" id="unsub-${f.file_id}">-</div>
                    <div class="col-span-1 text-center font-mono font-bold text-red-500" id="invalid-${f.file_id}">-</div>
                    <div class="col-span-1 text-center"><span class="font-bold text-green-600" id="valid-${f.file_id}">-</span></div>
                    <div class="col-span-2 text-right flex justify-end gap-2" id="action-${f.file_id}"></div>
                </div>`;
                container.insertAdjacentHTML('afterbegin', rowHtml);
            }

            // --- DYNAMIC UPDATES ---

            // [FIX 2] Dynamic Date Update (Shows Finish time instantly)
            const metaContainer = document.getElementById(`meta-${f.file_id}`);
            if (metaContainer && f.completed_at) {
                // If finish time isn't showing yet, add it
                if (!document.getElementById(`finish-${f.file_id}`)) {
                    const endObj = new Date(f.completed_at);
                    if (!isNaN(endObj) && endObj.getFullYear() > 1970) {
                        const finishHtml = `
                        <div id="finish-${f.file_id}" class="text-xs text-green-600 dark:text-green-400 flex items-center gap-1 mt-1 fade-in">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            ${endObj.toLocaleString()}
                        </div>`;
                        metaContainer.insertAdjacentHTML('beforeend', finishHtml);
                    }
                }
            }

            // Status Logic
            let statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-white">Pending</span>`;
            if (f.status === 'PROCESSING') {
                if (percent >= 100) {
                     statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300 border border-indigo-100 dark:border-indigo-800"><svg class="animate-spin -ml-0.5 mr-1.5 h-3 w-3 text-indigo-700" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Finalizing</span>`;
                } else {
                     statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 border border-blue-100 dark:border-blue-800"><span class="w-1.5 h-1.5 bg-blue-500 rounded-full mr-1.5 animate-pulse"></span>Processing</span>`;
                }
            }
            if (f.status === 'COMPLETED') statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 border border-green-100 dark:border-green-800">Completed</span>`;
            if (f.status === 'FAILED') statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-100">Failed</span>`;

            const elStatus = document.getElementById(`status-${f.file_id}`);
            if (elStatus && elStatus.innerHTML !== statusHtml) elStatus.innerHTML = statusHtml;

            // Numbers
            document.getElementById(`bounce-${f.file_id}`).textContent = f.filtered_bounce_count || '-';
            document.getElementById(`unsub-${f.file_id}`).textContent = f.filtered_unsub_count || '-';
            document.getElementById(`invalid-${f.file_id}`).textContent = f.invalid_record_count || '-';
            document.getElementById(`valid-${f.file_id}`).textContent = f.unique_record_count || '-';
            
            // Ring
            const circle = document.getElementById(`ring-${f.file_id}`);
            if (circle) circle.style.strokeDashoffset = (40 * 2 * Math.PI) - (percent / 100) * (40 * 2 * Math.PI);
            const elPerc = document.getElementById(`perc-${f.file_id}`);
            if(elPerc) elPerc.textContent = percent + '%';

            // Download Button
            const actionDiv = document.getElementById(`action-${f.file_id}`);
            if (actionDiv && f.unique_record_count > 0 && !actionDiv.innerHTML.includes('Download')) {
                actionDiv.innerHTML = `<a href="/api/v1/download/${f.file_id}/valid/?token=${token}" target="_blank" class="flex items-center gap-2 px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-100 rounded-md transition text-xs font-bold border border-indigo-200 dark:border-indigo-800">Download</a>`;
            }
        });

        if (hasActiveTasks) refreshIndicator.classList.remove('hidden');
        else refreshIndicator.classList.add('hidden');
    }

    // --- UPLOAD HANDLERS ---
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('fileInput').files[0]);
        document.getElementById('upload-status').innerHTML = '<span class="text-indigo-600 animate-pulse">Uploading...</span>';
        try {
            const res = await fetch(API_BASE, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
            if (res.ok) {
                document.getElementById('upload-status').innerHTML = '<span class="text-green-600">Started!</span>';
                fetchData();
            } else document.getElementById('upload-status').innerHTML = '<span class="text-red-600">Failed</span>';
        } catch (err) {
            document.getElementById('upload-status').innerHTML = '<span class="text-red-600">Error</span>';
        }
    });

    document.getElementById('suppressionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('suppressionFile').files[0]);
        document.getElementById('suppression-status').innerHTML = 'Processing...';
        try {
            const listType = document.getElementById('listType').value;
            const res = await fetch(`${LIST_UPLOAD_URL}${listType}/`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
            const data = await res.json();
            if (res.ok) document.getElementById('suppression-status').innerHTML = `<span class="text-green-600">Success! ${data.processed_rows} added.</span>`;
            else document.getElementById('suppression-status').innerHTML = `<span class="text-red-600">Error: ${data.detail || 'Failed'}</span>`;
        } catch (err) {
            document.getElementById('suppression-status').innerHTML = 'Network Error';
        }
    });
</script>