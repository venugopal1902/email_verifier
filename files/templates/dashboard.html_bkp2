<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Progress Ring Animation */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        /* Smooth Fade In */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-6 transition-colors duration-200">
    <div class="max-w-7xl mx-auto">
        
        <header class="flex justify-between items-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Verification Dashboard</h1>
                <div id="credit-container" class="hidden bg-indigo-50 dark:bg-indigo-900/30 px-4 py-2 rounded-lg border border-indigo-100 dark:border-indigo-800 flex items-center gap-2">
                    <span class="text-xs font-bold text-indigo-400 uppercase">Credits</span>
                    <span id="credit-balance" class="text-lg font-bold text-indigo-700 dark:text-indigo-300">Loading...</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    <span id="theme-icon">üåô</span>
                </button>

                <div id="auth-status" class="flex items-center space-x-3">
                    <span id="user-email" class="text-gray-600 dark:text-gray-400 text-sm">Guest</span>
                    <button id="logout-btn" onclick="logout()" class="hidden px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        Logout
                    </button>
                    <a id="login-link" href="/login/" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        Login
                    </a>
                </div>
            </div>
        </header>

        <div id="authenticated-content" class="hidden space-y-8">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <svg class="w-24 h-24 text-indigo-600 dark:text-indigo-400" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path></svg>
                    </div>
                    
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Verify New Email List</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-6 max-w-md">Upload your customer CSV file. The system will filter duplicates, bounces, and unsubscribes before verification.</p>
                    
                    <form id="uploadForm" class="relative z-10">
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <div class="w-full">
                                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Select File (CSV/Excel)</label>
                                <input type="file" id="fileInput" name="file" accept=".csv,.txt,.xlsx" required 
                                    class="block w-full text-sm text-slate-500 dark:text-slate-300
                                    file:mr-4 file:py-2.5 file:px-6
                                    file:rounded-lg file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-indigo-50 dark:file:bg-indigo-900 file:text-indigo-700 dark:file:text-indigo-300
                                    hover:file:bg-indigo-100 dark:hover:file:bg-indigo-800
                                    cursor-pointer border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 p-1
                                "/>
                            </div>
                            <button type="submit" id="uploadButton" class="w-full sm:w-auto px-8 py-3.5 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg hover:shadow-indigo-500/30 transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed mt-6 sm:mt-0">
                                Start Verification
                            </button>
                        </div>
                        <div id="upload-status" class="mt-4 text-sm font-medium h-5"></div>
                    </form>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="p-1.5 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-md">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                            </div>
                            <h2 class="text-lg font-bold text-gray-800 dark:text-white">Suppression Lists</h2>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Upload known bad emails to skip them in future verifications (save credits).</p>
                    
                        <form id="suppressionForm" class="space-y-3">
                            <div>
                                <select id="listType" class="w-full p-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:text-white">
                                    <option value="bounce">‚õî Bounced Emails</option>
                                    <option value="unsub">üîï Unsubscribed Emails</option>
                                </select>
                            </div>
                            <div>
                                <input type="file" id="suppressionFile" accept=".csv" required class="block w-full text-xs text-slate-500 dark:text-slate-300 file:mr-2 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-slate-100 dark:file:bg-gray-600 file:text-slate-700 dark:file:text-slate-300 hover:file:bg-slate-200 dark:hover:file:bg-gray-500"/>
                            </div>
                            <button type="submit" class="w-full py-2.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition text-sm shadow-sm">
                                Update List
                            </button>
                        </form>
                    </div>
                    <div id="suppression-status" class="mt-3 text-xs text-center h-4"></div>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-end mb-4 px-1">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Recent Verifications</h2>
                    <div id="auto-refresh-indicator" class="hidden flex items-center gap-2 px-3 py-1 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full text-xs font-medium border border-green-100 dark:border-green-800">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        Live Updating
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm overflow-hidden">
                    <div class="grid grid-cols-12 gap-4 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700 p-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        <div class="col-span-3">File Name</div>
                        <div class="col-span-2 text-center">Status</div>
                        <div class="col-span-1 text-center">Progress</div>
                        <div class="col-span-1 text-center text-red-600 dark:text-red-400">Bounced</div>
                        <div class="col-span-1 text-center text-orange-600 dark:text-orange-400">Unsub</div>
                        <div class="col-span-1 text-center text-red-600 dark:text-red-400">Invalid</div>
                        <div class="col-span-1 text-center text-green-600 dark:text-green-400">Valid</div>
                        <div class="col-span-2 text-right">Download</div>
                    </div>

                    <div id="status-area" class="divide-y divide-gray-100 dark:divide-gray-700 max-h-[600px] overflow-y-auto">
                        <div class="p-12 text-center text-gray-400 text-sm flex flex-col items-center">
                            Loading history...
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <div id="unauthenticated-message" class="hidden flex flex-col items-center justify-center min-h-[60vh]">
            <div class="bg-white dark:bg-gray-800 p-10 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 text-center max-w-md w-full">
                <div class="bg-indigo-50 dark:bg-indigo-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Access Restricted</h2>
                <p class="text-gray-500 dark:text-gray-400 mb-8">Please log in to your account to access the email verification tools.</p>
                <a href="/login/" class="block w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                    Go to Login
                </a>
            </div>
        </div>

    </div>

    <script>
        // DARK MODE LOGIC
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        // Init Theme
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
        }

        // --- CONFIG ---
        const API_CREDITS = '/api/v1/credits/';
        const API_BASE = '/api/v1/upload/';
        const HISTORY_URL = '/api/v1/history/';
        const LIST_UPLOAD_URL = '/api/v1/lists/upload/';
        
        // STATE
        const token = localStorage.getItem('access_token');
        let userData = {};
        try { userData = JSON.parse(localStorage.getItem('user_data') || '{}'); } catch(e) {}

        // DOM ELEMENTS
        const authContent = document.getElementById('authenticated-content');
        const guestContent = document.getElementById('unauthenticated-message');
        const logoutBtn = document.getElementById('logout-btn');
        const loginLink = document.getElementById('login-link');
        const userEmail = document.getElementById('user-email');
        const refreshIndicator = document.getElementById('auto-refresh-indicator');

        // INIT
        if (token) {
            authContent.classList.remove('hidden');
            guestContent.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            loginLink.classList.add('hidden');
            userEmail.textContent = userData.email || 'User';
            document.getElementById('credit-container').classList.remove('hidden'); 
            
            fetchCredits();
            setInterval(fetchCredits, 10000); // 10s credit refresh
            
            fetchData();
            setInterval(fetchData, 1000); // 1s data polling
        } else {
            authContent.classList.add('hidden');
            guestContent.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            loginLink.classList.remove('hidden');
        }

        // LOGOUT
        function logout() {
            localStorage.clear();
            window.location.href = '/login/';
        }

        // FETCH DATA
        async function fetchData() {
            if (!token) return;
            try {
                const res = await fetch(HISTORY_URL, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    updateTable(data.files);
                }
            } catch (e) { }
        }

        async function fetchCredits() {
            if (!token) return;
            try {
                const res = await fetch(API_CREDITS, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('credit-balance').textContent = Number(data.credits).toLocaleString();
                }
            } catch(e) {}
        }

        // --- CORE UPDATE LOGIC ---
        function updateTable(files) {
            const container = document.getElementById('status-area');
            
            if (!files || files.length === 0) {
                container.innerHTML = '<div class="p-12 text-center text-gray-400 text-sm">No verification history found.</div>';
                return;
            }

            let hasActiveTasks = false;

            files.forEach(f => {
                if (f.status === 'PROCESSING' || f.status === 'UPLOADED') hasActiveTasks = true;

                let row = document.getElementById(`row-${f.file_id}`);
                
                // 1. Calculate Progress
                let processed = (f.filtered_bounce_count||0) + (f.filtered_unsub_count||0) + (f.unique_record_count||0) + (f.invalid_record_count||0);
                let total = f.original_record_count || 1;
                let percent = 0;
                if (total > 0) percent = Math.min(Math.round((processed / total) * 100), 100);
                if (f.status === 'COMPLETED') percent = 100;

                // --- START & FINISH TIME ---
                let startDateStr = "Pending...";
                if (f.started_at) {
                    const d = new Date(f.started_at);
                    if (!isNaN(d) && d.getFullYear() > 1970) startDateStr = d.toLocaleString();
                }

                let finishHtml = '';
                if (f.completed_at) {
                    const d = new Date(f.completed_at);
                    if (!isNaN(d) && d.getFullYear() > 1970) {
                        finishHtml = `
                        <div class="text-xs text-green-600 dark:text-green-400 flex items-center gap-1 mt-1" title="Finished At">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            ${d.toLocaleString()}
                        </div>`;
                    }
                }

                // 2. Create Row Structure (Must Match Header Grid)
                if (!row) {
                    const rowHtml = `
                    <div id="row-${f.file_id}" class="grid grid-cols-12 gap-4 p-4 text-sm items-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition border-b border-gray-50 dark:border-gray-700 fade-in">
                        
                        <div class="col-span-3 overflow-hidden">
                            <div class="font-semibold text-gray-900 dark:text-white truncate" title="${f.file_name}">${f.file_name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ${startDateStr}
                            </div>
                            ${finishHtml}
                        </div>
                        
                        <div class="col-span-2 text-center" id="status-${f.file_id}"></div>
                        
                        <div class="col-span-1 flex justify-center items-center">
                             <div class="relative w-8 h-8">
                                <svg class="w-8 h-8 transform -rotate-90" viewBox="0 0 100 100">
                                    <circle class="text-gray-200 dark:text-gray-600 stroke-current" stroke-width="10" cx="50" cy="50" r="40" fill="transparent"></circle>
                                    <circle id="ring-${f.file_id}" class="text-indigo-600 stroke-current transition-all duration-500 ease-out" stroke-width="10" stroke-linecap="round" cx="50" cy="50" r="40" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
                                </svg>
                                <span id="perc-${f.file_id}" class="absolute inset-0 flex items-center justify-center text-[8px] font-bold text-gray-700 dark:text-gray-300">${percent}%</span>
                             </div>
                        </div>

                        <div class="col-span-1 text-center font-mono font-medium text-gray-600 dark:text-gray-400" id="bounce-${f.file_id}">-</div>
                        <div class="col-span-1 text-center font-mono font-medium text-gray-600 dark:text-gray-400" id="unsub-${f.file_id}">-</div>
                        <div class="col-span-1 text-center font-mono font-bold text-red-500" id="invalid-${f.file_id}">-</div>
                        <div class="col-span-1 text-center">
                            <span class="font-bold text-green-600" id="valid-${f.file_id}">${f.unique_record_count}</span>
                        </div>

                        <div class="col-span-2 text-right flex justify-end gap-2" id="action-${f.file_id}">
                            </div>
                    </div>`;
                    container.insertAdjacentHTML('afterbegin', rowHtml);
                }

                // 3. Dynamic Updates
                
                // FIX: Status Logic (Handles "Finalizing" state)
                let statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-white">Pending</span>`;
                
                if (f.status === 'PROCESSING') {
                    if (percent >= 100) {
                         statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300 border border-indigo-100 dark:border-indigo-800"><svg class="animate-spin -ml-0.5 mr-1.5 h-3 w-3 text-indigo-700" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Finalizing</span>`;
                    } else {
                         statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 border border-blue-100 dark:border-blue-800"><span class="w-1.5 h-1.5 bg-blue-500 rounded-full mr-1.5 animate-pulse"></span>Processing</span>`;
                    }
                }
                if (f.status === 'COMPLETED') statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 border border-green-100 dark:border-green-800">Completed</span>`;
                if (f.status === 'FAILED') statusHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-100">Failed</span>`;

                const elStatus = document.getElementById(`status-${f.file_id}`);
                if (elStatus && elStatus.innerHTML !== statusHtml) elStatus.innerHTML = statusHtml;

                // Update Numbers
                document.getElementById(`bounce-${f.file_id}`).textContent = f.filtered_bounce_count || '-';
                document.getElementById(`unsub-${f.file_id}`).textContent = f.filtered_unsub_count || '-';
                document.getElementById(`invalid-${f.file_id}`).textContent = f.invalid_record_count || '-';
                document.getElementById(`valid-${f.file_id}`).textContent = f.unique_record_count || '-';
                
                // Update Progress Ring
                const circle = document.getElementById(`ring-${f.file_id}`);
                const circumference = 40 * 2 * Math.PI; 
                if (circle) circle.style.strokeDashoffset = circumference - (percent / 100) * circumference;
                const elPerc = document.getElementById(`perc-${f.file_id}`);
                if(elPerc) elPerc.textContent = percent + '%';

                // Update Download Button
                const actionDiv = document.getElementById(`action-${f.file_id}`);
                if (actionDiv) {
                    if (f.unique_record_count > 0) {
                        actionDiv.innerHTML = `
                           <a href="/api/v1/download/${f.file_id}/valid/?token=${token}" 
                               target="_blank" 
                               class="flex items-center gap-2 px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-100 rounded-md transition text-xs font-bold border border-indigo-200 dark:border-indigo-800" 
                               title="Download Valid Emails">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0L8 8m4-4v12"></path></svg>
                                Download
                           </a>`;
                    } else {
                        actionDiv.innerHTML = `<span class="text-xs text-gray-300 italic px-2">No Valid Data</span>`;
                    }
                }
            });

            if (hasActiveTasks) refreshIndicator.classList.remove('hidden');
            else refreshIndicator.classList.add('hidden');
        }

        // --- UPLOAD HANDLERS ---
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('upload-status');
            if (!fileInput.files[0]) return;

            statusDiv.innerHTML = '<span class="text-indigo-600 flex items-center gap-2">Uploading...</span>';
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (res.ok) {
                    statusDiv.innerHTML = `<span class="text-green-600 font-medium">Upload Started!</span>`;
                    setTimeout(() => statusDiv.innerHTML = '', 3000);
                    fetchData();
                } else {
                    const data = await res.json();
                    statusDiv.innerHTML = `<span class="text-red-600 font-medium">Error: ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                statusDiv.innerHTML = '<span class="text-red-600 font-medium">Network Error</span>';
            }
        });

        document.getElementById('suppressionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const listType = document.getElementById('listType').value;
            const fileInput = document.getElementById('suppressionFile');
            const statusDiv = document.getElementById('suppression-status');

            if (!fileInput.files[0]) return;
            statusDiv.innerHTML = 'Processing...';
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${LIST_UPLOAD_URL}${listType}/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();
                if (res.ok) statusDiv.innerHTML = `<span class="text-green-600">Success! ${data.processed_rows} added.</span>`;
                else statusDiv.innerHTML = `<span class="text-red-600">Error: ${data.detail || 'Failed'}</span>`;
            } catch (err) {
                statusDiv.innerHTML = 'Network Error';
            }
        });
    </script>
</body>
</html>